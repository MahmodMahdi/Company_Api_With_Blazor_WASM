@page "/Employees"
@using Company.Shared.Models
@using MyCompany.BlazorUI.Repository.EmployeeRepository
@inject IEmployeeRepository employeeRepository
@inject IRepository<Employee> employeeService
@inject IJSRuntime JS
@using Microsoft.AspNetCore.Components.Authorization



<div class="container-fluid shadow-sm p-3 mb-5 bg-white rounded">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary m-0">All Employees</h2>
        <AuthorizeView>
            <Authorized>
                <a href="/Employees/Create" class="btn btn-success">Add New Employee</a>

            </Authorized>
        </AuthorizeView>
    </div>
</div>
@if (employees != null)
{
    @*   <div class="input-group">
        <input type="text" class="form-control" placeholder="Search by title..."
               @bind-value="Search" />
        <button type="button" class="btn btn-primary" @onclick="() => LoadEmployees(true)">Search</button>
    </div> *@

    <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="Search by name..." @bind-value="Search" />
        <button type="button" class="btn btn-primary" @onclick="HandleSearch"> Search </button>
        @if (!string.IsNullOrEmpty(Search))
        {
            <button type="button" class="btn btn-secondary" @onclick="ClearSearch">Clear </button>
        }
    </div>
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Age</th>
                <th>Address</th>
                <th>Salary</th>
                <th>Department</th>
                <AuthorizeView>
                    <Authorized>
                        <th>Action</th>
                    </Authorized>
                </AuthorizeView>
            </tr>
        </thead>
        <tbody>
            @foreach (var emp in employees.Data.Items)
            {
                <tr>
                    <td>@emp.Name</td>
                    <td>@emp.Age</td>
                    <td>@emp.Address</td>
                    <td>@emp.Salary</td>
                    <td>@(emp.departmentName ?? "No Department")</td>
                    <AuthorizeView>
                        <Authorized>
                            <td>
                                <a class="btn btn-warning" href="/Employees/Edit/@emp.Id">Edit</a> |
                                <a class="btn btn-secondary" href="/Employees/Details/@emp.Id">Details</a> |
                                <button class="btn btn-danger"
                                        @onclick="() => HandleDelete(emp.Id, emp.Name)">
                                    Delete
                                </button>
                            </td>
                        </Authorized>
                    </AuthorizeView>

                </tr>
            }
        </tbody>
    </table>
    <div class="mt-3 text-center">
        <button class="btn btn-primary"
                disabled="@(pageNumber <= 1)"
                @onclick="() => ChangePage(pageNumber - 1)">
            Previous
        </button>

        <span>Page @pageNumber of @TotalPages</span>

        <button class="btn btn-primary"
                disabled="@(pageNumber >= TotalPages)"
                @onclick="() => ChangePage(pageNumber + 1)">
            Next
        </button>
    </div>
}

@code {
    public GeneralResponse<PagedResult<Employee>> employees { get; set; }
    public Employee employee { get; set; }
    private string Search = string.Empty;
    private int TotalPages = 0;
    private int pageNumber = 1;
    private int PageSize = 10;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }
    private async Task LoadEmployees(bool resetPage = false)
    {
        if (resetPage) pageNumber = 1;

        var result = await employeeRepository.GetPaged(pageNumber, PageSize, Search);

        if (result.Success && result.Data != null)
        {
            employees = result;
            TotalPages = result.Data.TotalPages;
        }
        else
        {
            employees = new GeneralResponse<PagedResult<Employee>>
            {
                Success = false,
                Data = new PagedResult<Employee>()
            };
            TotalPages = 0;
        }
    }
    private async Task HandleSearch()
    {
        pageNumber = 1;
        await LoadEmployees();
    }

    private async Task ClearSearch()
    {
        Search = string.Empty;
        pageNumber = 1;
        await LoadEmployees();
    }

    private async Task ChangePage(int newPage)
    {
        pageNumber = newPage;
        await LoadEmployees();
    }
    async Task HandleDelete(int id, string name)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm",
            $"Are you sure you want to delete {name}?");

        if (confirmed)
        {
            var result = await employeeService.DeleteAsync(id);
            if (result.Success)
            {
                await LoadEmployees();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Failed to delete: {result.Message}");
            }
        }
    }
}
